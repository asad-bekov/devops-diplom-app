name: Test YC Secret Format

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug output'
        required: false
        default: 'false'

jobs:
  test-yc-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Check YC_SA_KEY format
        run: |
          echo "=== Testing YC_SA_KEY secret ==="
          
          echo "${{ secrets.YC_SA_KEY }}" > /tmp/sa-key.json
          
          echo "File size: $(wc -c < /tmp/sa-key.json) bytes"
          echo "First 10 chars: '$(head -c 10 /tmp/sa-key.json)'"
          echo "Last 10 chars: '$(tail -c 10 /tmp/sa-key.json)'"
          
          if python3 -c "import json, sys; json.load(open('/tmp/sa-key.json'))" 2>/dev/null; then
            echo "YC_SA_KEY is valid JSON"
            
            python3 << 'PYTHON_EOF'
import json
try:
    with open('/tmp/sa-key.json', 'r') as f:
        data = json.load(f)
    
    print("JSON structure is valid")
    print(f"Key ID: {data.get('id', 'NOT FOUND')}")
    print(f"Service Account ID: {data.get('service_account_id', 'NOT FOUND')}")
    print(f"Has private_key: {'private_key' in data}")
    print(f"Has public_key: {'public_key' in data}")
    
    critical = ['id', 'service_account_id', 'private_key']
    missing = [f for f in critical if f not in data]
    
    if missing:
        print(f"Missing critical fields: {missing}")
    else:
        print("All critical fields present")
        
except Exception as e:
    print(f"Error parsing JSON: {e}")
PYTHON_EOF
          else
            echo "YC_SA_KEY is NOT valid JSON"
            echo "First 200 chars:"
            head -c 200 /tmp/sa-key.json
          fi
          
      - name: Install yc CLI
        if: ${{ success() }}
        run: |
          echo "=== Installing yc CLI ==="
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | \
            bash -s -- -i /tmp/yc-install -n
          export PATH="/tmp/yc-install/bin:$PATH"
          yc version
          
      - name: Test Yandex Cloud Authentication
        if: ${{ success() }}
        run: |
          echo "=== Testing Yandex Cloud Authentication ==="
          export PATH="/tmp/yc-install/bin:$PATH"
          
          echo "${{ secrets.YC_SA_KEY }}" > /tmp/auth-key.json
          
          if yc config set service-account-key /tmp/auth-key.json && \
             yc config set cloud-id b1gm0hnoge59gnkmh3dl && \
             yc config set folder-id b1gm0hnoge59gnkmh3dl; then
            echo "yc configuration successful"
            
            if yc iam service-account get aje5tkmdv1edog0g029j --format json 2>&1 | grep -q "aje5tkmdv1edog0g029j"; then
              echo "SUCCESS! Authentication works correctly!"
              echo "The YC_SA_KEY secret is properly configured."
            else
              echo "Failed to access service account"
              echo "Error output:"
              yc iam service-account get aje5tkmdv1edog0g029j --format json 2>&1 | head -5
            fi
          else
            echo "Failed to configure yc"
          fi
