name: Simple CI/CD Test

on:
  push:
    branches: [ main ]

env:
  REGISTRY: cr.yandex/crplsrum4vurc408russ
  IMAGE_NAME: devops-diplom-app
  K8S_NAMESPACE: cicd

jobs:
  test-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Test YC_SA_KEY format
      run: |
        echo "Testing YC_SA_KEY format..."
        echo '${{ secrets.YC_SA_KEY }}' > test-key.json
        echo "Key length: $(wc -c < test-key.json) characters"
        echo "First 100 chars: $(head -c 100 test-key.json)"
        echo "Last 100 chars: $(tail -c 100 test-key.json)"
        
        # Try to parse as JSON
        if python3 -c "import json, sys; json.load(open('test-key.json')); print('JSON is valid')"; then
          echo "YC_SA_KEY is valid JSON"
        else
          echo "YC_SA_KEY is NOT valid JSON"
          exit 1
        fi
    
    - name: Test KUBE_CONFIG_DATA
      run: |
        echo "Testing KUBE_CONFIG_DATA..."
        echo '${{ secrets.KUBE_CONFIG_DATA }}' | base64 --decode > test-kubeconfig.yaml
        echo "Kubeconfig size: $(wc -l < test-kubeconfig.yaml) lines"
        
        # Check if it's valid YAML
        if python3 -c "import yaml, sys; yaml.safe_load(open('test-kubeconfig.yaml')); print('Kubeconfig is valid YAML')"; then
          echo "KUBE_CONFIG_DATA is valid"
        else
          echo "KUBE_CONFIG_DATA is NOT valid"
          exit 1
        fi

  build-image:
    runs-on: ubuntu-latest
    needs: test-build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Yandex Container Registry
      run: |
        # Save key to file and use it
        echo '${{ secrets.YC_SA_KEY }}' > /tmp/sa-key.json
        cat /tmp/sa-key.json | docker login cr.yandex -u json_key --password-stdin
    
    - name: Build and push
      run: |
        # Simple build without complex args
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy-test:
    runs-on: ubuntu-latest
    needs: build-image
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Configure Kubernetes
      env:
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      run: |
        echo "$KUBE_CONFIG_DATA" | base64 --decode > kubeconfig
        export KUBECONFIG=kubeconfig
        
        echo "=== Testing connection ==="
        kubectl cluster-info
        kubectl get ns
        
        echo "=== Testing deployment ==="
        # Simple test deployment
        cat <<EOT > test-deploy.yaml
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: simple-test
          namespace: $K8S_NAMESPACE
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: simple-test
          template:
            metadata:
              labels:
                app: simple-test
            spec:
              containers:
              - name: nginx
                image: nginx:alpine
                ports:
                - containerPort: 80
        EOT
        
        kubectl apply -f test-deploy.yaml
        sleep 10
        kubectl get pods -n $K8S_NAMESPACE
        kubectl delete -f test-deploy.yaml
