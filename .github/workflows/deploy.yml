name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ "v*" ]

env:
  REGISTRY: cr.yandex/crplsrum4vurc408russ
  IMAGE_NAME: devops-diplom-app
  K8S_NAMESPACE: cicd

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Login to Yandex Container Registry
        uses: docker/login-action@v2
        with:
          registry: cr.yandex
          username: json_key
          password: ${{ secrets.YC_SA_KEY }}

      - name: Build & Push
        uses: docker/build-push-action@v4
        with:
          context: devops-diplom-app
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 -d > ~/.kube/config

      - name: Deploy to Kubernetes (Rolling Update)
        env:
          YC_SA_KEY: ${{ secrets.YC_SA_KEY }}
        run: |
          kubectl apply -f k8s/namespace.yaml

          DOCKER_CONFIG_JSON=$(echo -n "{\"auths\":{\"cr.yandex\":{\"auth\":\"$(echo -n "json_key:$YC_SA_KEY" | base64 -w0)\"}}}" | base64 -w0)
          sed "s|{{DOCKER_CONFIG_JSON}}|$DOCKER_CONFIG_JSON|" k8s/registry-secret.yaml | kubectl apply -f -

          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name || 'main' }}"
          sed -e "s|{{IMAGE}}|$IMAGE|" -e "s|{{IMAGE_TAG}}|${GITHUB_SHA::7}|" k8s/deployment.yaml | kubectl apply -f -

          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/devops-diplom-app -n cicd
