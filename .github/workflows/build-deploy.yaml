name: Simple Build and Deploy

on:
  push:
    branches: [ main ]

jobs:
  test-auth:
    name: Test Authentication
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Debug - Show secret info
        run: |
          echo "Checking secrets..."
          echo "YC_SA_KEY length: ${#YC_SA_KEY}"
          echo "KUBE_CONFIG length: ${#KUBE_CONFIG}"
      
      - name: Test Yandex Cloud Auth
        run: |
          # Создаем файл с ключом
          cat << 'JSON_KEY' > /tmp/sa-key.json
          ${{ secrets.YC_SA_KEY }}
          JSON_KEY
          
          # Проверяем файл
          echo "=== File content (first 200 chars) ==="
          head -c 200 /tmp/sa-key.json
          echo ""
          echo "=== File info ==="
          ls -la /tmp/sa-key.json
          file /tmp/sa-key.json
          
          # Проверяем JSON валидность
          if jq . /tmp/sa-key.json > /dev/null 2>&1; then
            echo "✅ JSON is valid"
          else
            echo "❌ JSON is INVALID"
            echo "Actual content:"
            cat /tmp/sa-key.json
          fi
      
      - name: Test Kubernetes Auth
        run: |
          # Создаем kubeconfig
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          
          # Проверяем
          if kubectl cluster-info 2>/dev/null; then
            echo "✅ Kubeconfig is valid"
          else
            echo "❌ Kubeconfig is INVALID"
          fi
  
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test-auth
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Yandex Container Registry
        run: |
          # Метод 1: Используем yc CLI
          echo "=== Method 1: Using yc CLI ==="
          
          # Устанавливаем yc
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i /usr/local -n
          
          # Создаем файл с ключом
          cat << 'YC_KEY' > /tmp/yc-key.json
          ${{ secrets.YC_SA_KEY }}
          YC_KEY
          
          # Настраиваем yc
          yc config set service-account-key /tmp/yc-key.json
          yc config set cloud-id b1gm0hnoge59gnkmh3dl
          yc config set folder-id b1gm0hnoge59gnkmh3dl
          
          # Настраиваем docker
          yc container registry configure-docker
          
          # Проверяем
          echo "✅ Docker configured for Yandex Cloud"
      
      - name: Build and Push Image
        run: |
          # Простая сборка и пуш
          REGISTRY="cr.yandex/crplsrum4vurc408russ"
          IMAGE_NAME="diploma-app"
          
          docker build -t $REGISTRY/$IMAGE_NAME:test-${{ github.sha }} .
          docker push $REGISTRY/$IMAGE_NAME:test-${{ github.sha }}
          
          echo "✅ Image pushed successfully"
  
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
          # Тестируем подключение
          kubectl cluster-info
          kubectl get nodes
      
      - name: Deploy Application
        run: |
          # Обновляем образ
          kubectl set image deployment/diploma-app \
            diploma-app=cr.yandex/crplsrum4vurc408russ/diploma-app:test-${{ github.sha }} \
            -n default
            
          # Ждем обновления
          kubectl rollout status deployment/diploma-app -n default --timeout=300s
          
          echo "✅ Application deployed successfully"
