name: FINAL Test - YC Secret

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Test YC_SA_KEY format
        run: |
          echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ ==="
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å —Å–µ–∫—Ä–µ—Ç–æ–º
          echo "${{ secrets.YC_SA_KEY }}" > /tmp/test-secret.json
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º JSON
          if python3 -c "import json; json.load(open('/tmp/test-secret.json'))"; then
            echo "‚úÖ –°–µ–∫—Ä–µ—Ç - –≤–∞–ª–∏–¥–Ω—ã–π JSON"
          else
            echo "‚ùå –°–µ–∫—Ä–µ—Ç - –ù–ï –≤–∞–ª–∏–¥–Ω—ã–π JSON"
            echo "–ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤:"
            head -c 100 /tmp/test-secret.json
            echo ""
            exit 1
          fi
          
      - name: Test Yandex Cloud auth
        run: |
          echo "=== –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ==="
          echo "${{ secrets.YC_SA_KEY }}" > /tmp/auth-key.json
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º yc
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | \
            bash -s -- -i /tmp/yc -n
          export PATH="/tmp/yc/bin:$PATH"
          
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º
          if yc config set service-account-key /tmp/auth-key.json && \
             yc config set cloud-id b1gm0hnoge59gnkmh3dl && \
             yc config set folder-id b1gm0hnoge59gnkmh3dl; then
            echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞"
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É
            if yc iam service-account get aje5tkmdv1edog0g029j --format short 2>&1 | grep -q "aje5tkmdv1edog0g029j"; then
              echo "üéâ –£–°–ü–ï–•! –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            else
              echo "‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã"
              yc iam service-account get aje5tkmdv1edog0g029j --format short
            fi
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
          fi
