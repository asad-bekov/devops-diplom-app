name: Simple Build and Deploy

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build and Push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Configure Yandex Cloud Auth
        run: |
          # Создаем файл с ключом из секрета
          echo '${{ secrets.YC_SA_KEY }}' > /tmp/sa-key.json
          
          # Проверяем JSON
          if ! jq . /tmp/sa-key.json > /dev/null 2>&1; then
            echo "❌ ERROR: Invalid JSON in YC_SA_KEY"
            echo "First 200 chars of secret:"
            head -c 200 /tmp/sa-key.json
            exit 1
          fi
          
          echo "✅ JSON key is valid"
      
      - name: Build and Push with Docker CLI
        run: |
          # Просто собираем образ (без пуша для теста)
          docker build -t test-image:${{ github.sha }} .
          echo "✅ Image built successfully"
  
  deploy:
    name: Deploy to Cluster
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo '${{ secrets.KUBE_CONFIG }}' | base64 -d > ~/.kube/config
          
          # Проверяем доступ
          echo "Testing cluster connection..."
          kubectl cluster-info
          kubectl get nodes
