name: DEBUG - Validate YC Secret

on:
  workflow_dispatch:

jobs:
  debug-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Save and Inspect Secret (RAW)
        id: inspect_raw
        run: |
          echo "=== 1. RAW SECRET DUMP (for debugging) ==="
          # –í–ê–ñ–ù–û: –ù–µ –≤—ã–≤–æ–¥–∏–º –≤–µ—Å—å —Å–µ–∫—Ä–µ—Ç –≤ –ª–æ–≥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          echo "${{ secrets.YC_SA_KEY }}" > /tmp/secret.raw.txt
          
          echo "File size in bytes: $(wc -c < /tmp/secret.raw.txt)"
          echo "First 300 chars (visible):"
          head -c 300 /tmp/secret.raw.txt | cat -A
          echo ""
          echo "Last 300 chars (visible):"
          tail -c 300 /tmp/secret.raw.txt | cat -A
          echo ""
          
          echo "=== 2. CHECK FOR COMMON ISSUES ==="
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å {
          if head -c 1 /tmp/secret.raw.txt | grep -q '{'; then
            echo "‚úÖ PASS: Secret starts with '{'"
          else
            echo "‚ùå FAIL: Secret does NOT start with '{'. It starts with: '$(head -c 1 /tmp/secret.raw.txt)'"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ª–∏ –Ω–∞ }
          if tail -c 2 /tmp/secret.raw.txt | tr -d '\n' | grep -q '}'; then
            echo "‚úÖ PASS: Secret ends with '}'"
          else
            echo "‚ùå FAIL: Secret does NOT end with '}'. It ends with: '$(tail -c 2 /tmp/secret.raw.txt)'"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ï—Å—Ç—å –ª–∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `***`)
          if head -c 10 /tmp/secret.raw.txt | grep -q '^\*\*\*'; then
            echo "‚ö†Ô∏è  WARNING: Secret might start with GitHub's mask '***'"
          fi

      - name: Validate as JSON
        id: validate_json
        run: |
          echo "=== 3. ATTEMPT TO PARSE AS JSON ==="
          # –ö–æ–ø–∏—Ä—É–µ–º raw —Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
          cp /tmp/secret.raw.txt /tmp/secret_to_parse.json
          
          # –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ (BOM, –ø—Ä–æ–±–µ–ª—ã)
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Python –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
          python3 << 'PYEOF'
import json, sys, os
with open('/tmp/secret.raw.txt', 'r') as f:
    content = f.read().strip()
    
print(f"Secret length after strip: {len(content)}")
print(f"First 5 chars (repr): {repr(content[:5])}")
print(f"Last 5 chars (repr): {repr(content[-5:])}")

try:
    parsed = json.loads(content)
    print("‚úÖ SUCCESS: Secret is VALID JSON!")
    print(f"JSON keys found: {list(parsed.keys())}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
    critical_fields = ['id', 'service_account_id', 'private_key']
    for field in critical_fields:
        if field in parsed:
            print(f"   ‚úÖ Field '{field}' exists")
        else:
            print(f"   ‚ùå Field '{field}' is MISSING!")
            
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
    if 'private_key' in parsed:
        priv = parsed['private_key']
        if '-----BEGIN PRIVATE KEY-----' in priv:
            print("   ‚úÖ Private key has correct BEGIN marker")
        else:
            print("   ‚ùå Private key MISSING BEGIN marker!")
            
except json.JSONDecodeError as e:
    print(f"‚ùå FAILED: Secret is NOT valid JSON.")
    print(f"   Error: {e.msg} at line {e.lineno}, column {e.colno}")
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    lines = content.split('\n')
    problem_line = max(0, e.lineno - 1)
    start = max(0, problem_line - 2)
    end = min(len(lines), problem_line + 3)
    print(f"   Context around line {e.lineno}:")
    for i in range(start, end):
        prefix = '>>>' if i == problem_line else '   '
        print(f"   {prefix} {i+1}: {lines[i]}")
PYEOF

      - name: Test with yc CLI (if JSON is valid)
        id: test_yc
        # –≠—Ç–æ—Ç —à–∞–≥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ validate_json –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ (exit code 0)
        if: steps.validate_json.outcome == 'success'
        run: |
          echo "=== 4. TESTING WITH YC CLI ==="
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º yc
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | \
            bash -s -- -i /tmp/yc-install-dir -n
          export PATH="/tmp/yc-install-dir/bin:$PATH"
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Python –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è JSON —Ñ–∞–π–ª–∞
          python3 << 'PYEOF'
import json, os, subprocess, sys
with open('/tmp/secret.raw.txt', 'r') as f:
    secret_content = f.read().strip()
secret_data = json.loads(secret_content)

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
with open('/tmp/sa-key-for-yc.json', 'w') as f:
    json.dump(secret_data, f)
print("‚úÖ Service account key saved to file")
PYEOF
          
          # –ü—Ä–æ–±—É–µ–º –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å yc
          echo "Setting up yc configuration..."
          if yc config set service-account-key /tmp/sa-key-for-yc.json && \
             yc config set cloud-id b1gm0hnoge59gnkmh3dl && \
             yc config set folder-id b1gm0hnoge59gnkmh3dl; then
            echo "‚úÖ yc configured successfully"
            
            # –ü—Ä–æ–±—É–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Å—Ç—É—é –∫–æ–º–∞–Ω–¥—É
            echo "Testing API access..."
            if yc iam service-account get aje5tkmdv1edog0g029j --format short 2>&1 | grep -q "aje5tkmdv1edog0g029j"; then
              echo "üéâ SUCCESS! Authentication works perfectly!"
            else
              echo "‚ùå API call failed. Command output:"
              yc iam service-account get aje5tkmdv1edog0g029j --format short
            fi
          else
            echo "‚ùå Failed to configure yc"
          fi

      - name: Final Instructions
        if: failure()
        run: |
          echo "=== üõ†Ô∏è  TROUBLESHOOTING INSTRUCTIONS ==="
          echo ""
          echo "If validation failed, here's what to do:"
          echo "1. Go to GitHub ‚Üí Repository Settings ‚Üí Secrets ‚Üí Actions ‚Üí YC_SA_KEY"
          echo "2. Click 'Update'"
          echo "3. DELETE ALL existing content"
          echo "4. Get a FRESH key using this exact command on your server:"
          echo "   yc iam key create --service-account-id aje5tkmdv1edog0g029j --output /tmp/new-key.json"
          echo "5. Copy the ENTIRE content of /tmp/new-key.json"
          echo "6. Paste it into the GitHub secret field"
          echo "7. Make sure it's ONE LINE if possible (no extra spaces at start/end)"
          echo "8. Click Save"
          echo ""
          echo "Then run this workflow again."
