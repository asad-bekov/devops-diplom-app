name: Production CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  verify-secrets:
    name: Verify Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Check YC_SA_KEY
        run: |
          echo "=== Testing YC_SA_KEY ==="
          echo '${{ secrets.YC_SA_KEY }}' > /tmp/key.json
          
          # Проверяем JSON
          if jq . /tmp/key.json > /dev/null 2>&1; then
            echo "✅ YC_SA_KEY: Valid JSON"
            echo "   Key ID: $(jq -r '.id' /tmp/key.json)"
          else
            echo "❌ YC_SA_KEY: Invalid JSON"
            echo "First 100 chars:"
            head -c 100 /tmp/key.json
            exit 1
          fi
      
      - name: Check KUBE_CONFIG
        run: |
          echo "=== Testing KUBE_CONFIG ==="
          echo '${{ secrets.KUBE_CONFIG }}' | base64 -d > /tmp/kubeconfig
          
          if grep -q "server:" /tmp/kubeconfig; then
            echo "✅ KUBE_CONFIG: Contains server URL"
            echo "   Server: $(grep 'server:' /tmp/kubeconfig | head -1)"
          else
            echo "❌ KUBE_CONFIG: Missing server URL"
            exit 1
          fi
  
  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest
    needs: verify-secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Configure Yandex Cloud CLI
        run: |
          # Устанавливаем yc
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | \
            bash -s -- -i /tmp/yc -n
          export PATH="/tmp/yc/bin:$PATH"
          
          # Настраиваем аутентификацию
          echo '${{ secrets.YC_SA_KEY }}' > /tmp/sa-key.json
          yc config set service-account-key /tmp/sa-key.json
          yc config set cloud-id b1gm0hnoge59gnkmh3dl
          yc config set folder-id b1gm0hnoge59gnkmh3dl
          
          # Настраиваем docker
          yc container registry configure-docker
          
          echo "✅ Yandex Cloud configured"
      
      - name: Build and Push Docker Image
        run: |
          export PATH="/tmp/yc/bin:$PATH"
          
          REGISTRY="cr.yandex/crplsrum4vurc408russ"
          IMAGE_NAME="diploma-app"
          TAG="${{ github.sha }}"
          
          echo "Building image: $REGISTRY/$IMAGE_NAME:$TAG"
          
          # Сборка и пуш
          docker build -t $REGISTRY/$IMAGE_NAME:$TAG .
          docker push $REGISTRY/$IMAGE_NAME:$TAG
          
          # Также пушим latest
          docker tag $REGISTRY/$IMAGE_NAME:$TAG $REGISTRY/$IMAGE_NAME:latest
          docker push $REGISTRY/$IMAGE_NAME:latest
          
          echo "✅ Image pushed: $REGISTRY/$IMAGE_NAME:$TAG"
  
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo '${{ secrets.KUBE_CONFIG }}' | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
          echo "=== Cluster Info ==="
          kubectl cluster-info || echo "Cluster info may fail, but deployment can still work"
          
          echo "=== Nodes ==="
          kubectl get nodes
      
      - name: Update Application
        run: |
          echo "=== Updating deployment ==="
          
          # Обновляем образ в существующем деплойменте
          kubectl set image deployment/diploma-app \
            diploma-app=cr.yandex/crplsrum4vurc408russ/diploma-app:${{ github.sha }} \
            -n default \
            --record
          
          echo "✅ Deployment updated with new image"
      
      - name: Wait for rollout
        run: |
          echo "=== Waiting for rollout ==="
          kubectl rollout status deployment/diploma-app -n default --timeout=300s
      
      - name: Verify deployment
        run: |
          echo "=== Verification ==="
          
          echo "1. Pods:"
          kubectl get pods -n default -l app=diploma-app -o wide
          
          echo ""
          echo "2. Services:"
          kubectl get svc -n default -l app=diploma-app
          
          echo ""
          echo "3. Ingress:"
          kubectl get ingress -n default
          
          echo ""
          echo "✅ Application deployed successfully!"
          echo ""
          echo "=== Access URLs ==="
          echo "HTTP via NodePort:"
          echo "- http://178.154.230.79:32251"
          echo "- http://158.160.79.246:32251"
          echo ""
          echo "Ingress host (if DNS configured):"
          echo "- http://diploma.89.169.142.18.nip.io"
