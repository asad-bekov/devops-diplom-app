name: Final Production Pipeline

on:
  push:
    branches: [ main ]

jobs:
  verify:
    name: Verify Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Check YC_SA_KEY
        run: |
          echo "Testing YC_SA_KEY..."
          echo '${{ secrets.YC_SA_KEY }}' > /tmp/test.json
          
          if echo '${{ secrets.YC_SA_KEY }}' | grep -q '^{.*}$'; then
            echo "✅ YC_SA_KEY looks like JSON"
          else
            echo "❌ YC_SA_KEY doesn't look like JSON"
            echo "First 50 chars: '${{ secrets.YC_SA_KEY }}'"
            exit 1
          fi
  
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: verify
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Docker
        uses: docker/setup-buildx-action@v2
      
      - name: Test Docker Build
        run: |
          # Просто тест сборки
          docker build -t test-image .
          echo "✅ Docker build successful"
  
  deploy:
    name: Manual Deploy Instructions
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Generate Deployment Commands
        run: |
          echo "=== DEPLOYMENT INSTRUCTIONS ==="
          echo ""
          echo "1. First, check your YC_SA_KEY in GitHub Secrets:"
          echo "   - It should be FULL JSON, not just ID"
          echo "   - Should start with '{' and end with '}'"
          echo ""
          echo "2. Deploy manually from your local machine:"
          echo ""
          echo "   # 1. Build and push image"
          echo "   docker build -t cr.yandex/crplsrum4vurc408russ/diploma-app:manual ."
          echo "   docker push cr.yandex/crplsrum4vurc408russ/diploma-app:manual"
          echo ""
          echo "   # 2. Deploy to Kubernetes"
          echo "   kubectl set image deployment/diploma-app \\"
          echo "     diploma-app=cr.yandex/crplsrum4vurc408russ/diploma-app:manual \\"
          echo "     -n default"
          echo ""
          echo "   # 3. Verify"
          echo "   kubectl rollout status deployment/diploma-app -n default"
          echo "   kubectl get pods -n default -l app=diploma-app"
          echo ""
          echo "3. Test access:"
          echo "   curl http://178.154.230.79:32251"
          echo ""
          echo "=== CURRENT STATUS ==="
          echo "Ingress NodePort: 32251"
          echo "Worker nodes accessible:"
          echo "  - 178.154.230.79:32251"
          echo "  - 158.160.79.246:32251"
          echo ""
          echo "Application pods:"
          echo "  - diploma-app-7667465bfc-hdsvv"
          echo "  - diploma-app-7667465bfc-px5pt"
