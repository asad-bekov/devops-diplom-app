name: TEST Secret Only

on:
  workflow_dispatch:  # Только ручной запуск

jobs:
  test-secret:
    name: Test YC_SA_KEY Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Save secret to file
        run: |
          echo "=== Step 1: Saving secret to file ==="
          echo "${{ secrets.YC_SA_KEY }}" > /tmp/secret-content.txt
          echo "File size: $(wc -c < /tmp/secret-content.txt) bytes"
          echo "Line count: $(wc -l < /tmp/secret-content.txt) lines"
      
      - name: Show EXACT content
        run: |
          echo "=== Step 2: EXACT content (with visible characters) ==="
          echo "First 200 characters:"
          head -c 200 /tmp/secret-content.txt
          echo ""
          echo ""
          echo "Last 200 characters:"
          tail -c 200 /tmp/secret-content.txt
          echo ""
      
      - name: Test as JSON
        run: |
          echo "=== Step 3: Testing as JSON ==="
          
          # Способ 1: Python
          if python3 -c "import json, sys; json.load(open('/tmp/secret-content.txt')); print('✅ Python: VALID JSON')" 2>/dev/null; then
            echo "Python: VALID JSON"
          else
            echo "❌ Python: INVALID JSON"
            python3 -c "import json, sys; json.load(open('/tmp/secret-content.txt'))" 2>&1 | head -5
          fi
          
          # Способ 2: jq
          if jq . /tmp/secret-content.txt > /tmp/parsed.json 2>/dev/null; then
            echo "✅ jq: VALID JSON"
            echo "JSON structure:"
            jq 'keys' /tmp/secret-content.txt
          else
            echo "❌ jq: INVALID JSON"
            echo "Error:"
            jq . /tmp/secret-content.txt 2>&1 | head -10
          fi
      
      - name: Hex dump for invisible characters
        run: |
          echo "=== Step 4: Hex dump (invisible characters) ==="
          hexdump -C /tmp/secret-content.txt | head -20
      
      - name: Manual fix instructions
        if: failure()
        run: |
          echo "=== FIX INSTRUCTIONS ==="
          echo ""
          echo "1. In GitHub: Settings → Secrets → YC_SA_KEY"
          echo "2. DELETE everything"
          echo "3. Paste EXACTLY this (starting with {, ending with }):"
          echo ""
          echo '{"id":"aje8nb1o0kij6dvg4tq1","service_account_id":"aje5tkmdv1edog0g029j","created_at":"2025-12-15T11:10:59.123456Z","key_algorithm":"RSA_2048","public_key":"-----BEGIN PUBLIC KEY-----\nMIIBI...\n-----END PUBLIC KEY-----\n","private_key":"-----BEGIN PRIVATE KEY-----\nMIIEv...\n-----END PRIVATE KEY-----\n"}'
          echo ""
          echo "4. NO extra spaces at beginning or end"
          echo "5. Click Save"
