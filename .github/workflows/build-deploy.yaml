name: Validate Secrets and Test YC Access

on:
  workflow_dispatch:  # Запуск только вручную

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug YC_SA_KEY
        run: |
          echo "=== Проверка формата YC_SA_KEY ==="
          # Сохраняем секрет во временный файл
          echo "${{ secrets.YC_SA_KEY }}" > /tmp/yc_key.json
          echo "Размер файла: $(wc -c < /tmp/yc_key.json) байт"
          
          # Пробуем прочитать как JSON
          if jq . /tmp/yc_key.json > /dev/null 2>&1; then
            echo "✅ Секрет YC_SA_KEY - валидный JSON"
            echo "Содержит поля:"
            jq 'keys' /tmp/yc_key.json
          else
            echo "❌ Секрет YC_SA_KEY - НЕ валидный JSON"
            echo "Первые 200 символов:"
            head -c 200 /tmp/yc_key.json
            echo ""
          fi
          
          # Проверяем наличие приватного ключа
          if grep -q "BEGIN PRIVATE KEY" /tmp/yc_key.json; then
            echo "✅ Приватный ключ обнаружен в секрете"
          else
            echo "❌ Приватный ключ НЕ найден в секрете"
          fi

      - name: Test Yandex Cloud Authentication
        if: success()  # Запускается, только если предыдущий шаг успешен
        run: |
          echo "=== Тестирование аутентификации в Yandex Cloud ==="
          # Сохраняем ключ
          echo "${{ secrets.YC_SA_KEY }}" > /tmp/sa_key.json
          # Устанавливаем yc (менеджер Yandex Cloud CLI)
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | \
            bash -s -- -i /tmp/yc-temp -n
          export PATH="/tmp/yc-temp/bin:$PATH"
          # Пробуем аутентифицироваться
          if yc config set service-account-key /tmp/sa_key.json && \
             yc config set cloud-id b1gm0hnoge59gnkmh3dl && \
             yc config set folder-id b1gm0hnoge59gnkmh3dl; then
            echo "✅ Конфигурация yc успешна"
            # Пробуем выполнить простую команду
            if yc iam service-account get aje5tkmdv1edog0g029j 2>&1 | grep -q "aje5tkmdv1edog0g029j"; then
              echo "✅ Аутентификация и доступ к API успешны!"
            else
              echo "❌ Ошибка доступа к API"
              yc iam service-account get aje5tkmdv1edog0g029j 2>&1 | head -5
            fi
          else
            echo "❌ Ошибка конфигурации yc"
          fi
