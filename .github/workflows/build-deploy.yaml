name: Final CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  REGISTRY: cr.yandex/crplsrum4vurc408russ
  IMAGE_NAME: diploma-app
  K8S_NAMESPACE: default

jobs:
  build:
    name: Build and Push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Yandex Container Registry
        run: |
          echo "${{ secrets.YC_SA_KEY }}" > /tmp/sa-key.json
          yc config set service-account-key /tmp/sa-key.json
          yc config set cloud-id b1gm0hnoge59gnkmh3dl
          yc config set folder-id b1gm0hnoge59gnkmh3dl
          yc container registry configure-docker
      
      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
  
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
      
      - name: Deploy Application
        run: |
          # Update deployment
          kubectl set image deployment/diploma-app \
            nginx=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -n ${{ env.K8S_NAMESPACE }}
      
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/diploma-app -n ${{ env.K8S_NAMESPACE }}
          echo "âœ… Application deployed successfully!"
          echo "Access URLs:"
          echo "- http://178.154.230.79:30080"
          echo "- http://158.160.79.246:30080"
