name: Build and Deploy to Kubernetes

on:
  push:
    branches: [ main ]

env:
  REGISTRY: cr.yandex/crplsrum4vurc408russ
  IMAGE_NAME: diploma-app

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Install Yandex Cloud CLI
        run: |
          # Устанавливаем yc в домашнюю директорию
          curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | \
            bash -s -- -i $HOME/yc-install -n
          
          export PATH="$HOME/yc-install/bin:$PATH"
          yc --version
      
      - name: Configure Yandex Cloud Auth
        run: |
          export PATH="$HOME/yc-install/bin:$PATH"
          
          # Создаем файл с ключом из секрета
          echo '${{ secrets.YC_SA_KEY }}' > $HOME/sa-key.json
          
          # Настраиваем yc
          yc config set service-account-key $HOME/sa-key.json
          yc config set cloud-id b1gm0hnoge59gnkmh3dl
          yc config set folder-id b1gm0hnoge59gnkmh3dl
          
          # Настраиваем docker для Yandex Container Registry
          yc container registry configure-docker
          
          echo "✅ Authentication configured"
      
      - name: Build and Push Docker Image
        run: |
          export PATH="$HOME/yc-install/bin:$PATH"
          
          # Сборка и пуш
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          # Также пушим latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          echo "✅ Image pushed: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
  
  deploy:
    name: Deploy to Kubernetes
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo '${{ secrets.KUBE_CONFIG }}' | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          # Тестируем подключение
          kubectl cluster-info
          kubectl get nodes
      
      - name: Deploy Application
        run: |
          # Обновляем образ в deployment
          kubectl set image deployment/diploma-app \
            diploma-app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -n default \
            --record
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/diploma-app -n default --timeout=300s
      
      - name: Verify deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment diploma-app -n default
          echo ""
          echo "=== Pods Status ==="
          kubectl get pods -n default -l app=diploma-app
          echo ""
          echo "=== Service Status ==="
          kubectl get svc diploma-app -n default
